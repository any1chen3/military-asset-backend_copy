<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ReportUnitMapper.xml -->
<mapper namespace="com.military.asset.mapper.ReportUnitMapper">
    <select id="selectByProvinceNull" resultType="com.military.asset.entity.ReportUnit">
        SELECT id, report_unit, province FROM report_unit WHERE province IS NULL or province = ''
    </select>
    <update id="updateProvince">
        UPDATE report_unit SET province = #{province} WHERE id = #{id}
    </update>

    <!-- 1. æ ¹æ®ä¸ŠæŠ¥å•ä½åç§°æŸ¥è¯¢ -->
    <select id="selectByReportUnitName" resultType="com.military.asset.entity.ReportUnit">
        SELECT * FROM report_unit
        WHERE report_unit = #{reportUnit}
    </select>

    <!-- 2. ç»Ÿè®¡è½¯ä»¶èµ„äº§è¡¨ä¸­è¯¥å•ä½çš„æ•°é‡ -->
    <select id="countSoftwareAsset" resultType="java.lang.Long">
        SELECT COUNT(*) FROM software_asset
        WHERE report_unit = #{reportUnit}
    </select>

    <!-- 3. ç»Ÿè®¡ç½‘ä¿¡èµ„äº§è¡¨ä¸­è¯¥å•ä½çš„æ•°é‡ -->
    <select id="countCyberAsset" resultType="java.lang.Long">
        SELECT COUNT(*) FROM cyber_asset
        WHERE report_unit = #{reportUnit}
    </select>

    <!-- 4. ç»Ÿè®¡æ•°æ®å†…å®¹èµ„äº§è¡¨ä¸­è¯¥å•ä½çš„æ•°é‡ -->
    <select id="countDataContentAsset" resultType="java.lang.Long">
        SELECT COUNT(*) FROM data_content_asset
        WHERE report_unit = #{reportUnit}
    </select>

    <!-- æ ¹æ®èµ„äº§è¡¨ç±»åž‹èŽ·å–ä¸ŠæŠ¥å•ä½åˆ—è¡¨ - ä¿®æ­£å­—æ®µå -->
    <!-- ç”¨äºŽæŽ¥å£3 -->
    <select id="selectReportUnitsByTableType" resultType="java.lang.String">
        SELECT DISTINCT report_unit FROM report_unit
        WHERE 1=1
        <if test="tableType == 'software'">
            AND source_table_software_asset = 1
        </if>
        <if test="tableType == 'cyber'">
            AND source_table_cyber_asset = 1
        </if>
        <if test="tableType == 'data'">
            AND source_table_data_content_asset = 1
        </if>
        ORDER BY report_unit
    </select>

    <!--
        æŽ¥å£4(b)ï¼šç»Ÿè®¡ä¸ŠæŠ¥å•ä½è¡¨å„çœä»½å•ä½æ•°é‡ï¼ˆåªç»Ÿè®¡æœ‰æ•°æ®çš„å•ä½ï¼‰

        æ–°é€»è¾‘è¯´æ˜Žï¼š
        - ç›´æŽ¥ä»Žreport_unitè¡¨ç»Ÿè®¡ï¼Œä¸æ¶‰åŠå…³è”æŸ¥è¯¢
        - åªç»Ÿè®¡åœ¨è‡³å°‘ä¸€ä¸ªèµ„äº§è¡¨ä¸­æœ‰æ•°æ®çš„å•ä½
        - é€šè¿‡source_table_xxx_assetå­—æ®µåˆ¤æ–­å•ä½æ˜¯å¦æœ‰æ•°æ®

        æŸ¥è¯¢æ­¥éª¤ï¼š
        1. ä»Žreport_unitè¡¨ç›´æŽ¥æŸ¥è¯¢
        2. ä½¿ç”¨WHEREæ¡ä»¶ç­›é€‰æœ‰æ•°æ®çš„å•ä½ï¼ˆsource_table_xxx_assetè‡³å°‘æœ‰ä¸€ä¸ªä¸º1ï¼‰
        3. æŒ‰çœä»½åˆ†ç»„ç»Ÿè®¡å•ä½æ•°é‡
        4. æŽ’é™¤çœä»½ä¸ºNULLæˆ–ç©ºå­—ç¬¦ä¸²çš„è®°å½•
        5. æŒ‰å•ä½æ•°é‡é™åºæŽ’åˆ—

        ä¸ŽæŽ¥å£4(a)çš„å…³ç³»ï¼š
        - 4(a)åˆ†åˆ«ç»Ÿè®¡ä¸‰ä¸ªèµ„äº§è¡¨çš„çœä»½åˆ†å¸ƒ
        - 4(b)ç»Ÿè®¡å„çœä»½æœ‰æ•°æ®çš„å•ä½æ€»æ•°ï¼ˆåŽ»é‡ï¼‰
        - 4(b)çš„ç»“æžœåº”è¯¥å¤§è‡´ç­‰äºŽä¸‰ä¸ªèµ„äº§è¡¨ç»Ÿè®¡æ•°çš„åŽ»é‡åˆå¹¶

        ä¼˜åŠ¿ï¼š
        - ç›´æŽ¥ç»Ÿè®¡ï¼Œæ€§èƒ½æ›´å¥½
        - åæ˜ äº†å„çœä»½æœ‰æ•°æ®çš„å•ä½æ€»æ•°
        - é¿å…äº†é‡å¤ç»Ÿè®¡ï¼ˆä¸€ä¸ªå•ä½åœ¨å¤šä¸ªèµ„äº§è¡¨æœ‰æ•°æ®ä¹Ÿåªç»Ÿè®¡ä¸€æ¬¡ï¼‰
    -->
    <select id="selectProvinceUnitStats" resultType="java.util.HashMap">
        SELECT
            province,
            COUNT(*) as count
        FROM report_unit
        WHERE province IS NOT NULL
          AND province != ''
          AND (source_table_software_asset = 1
           OR source_table_cyber_asset = 1
           OR source_table_data_content_asset = 1)
        GROUP BY province
        ORDER BY count DESC
    </select>
    <select id="selectAll" resultType="com.military.asset.entity.ReportUnit">
        SELECT id, report_unit, province
        FROM report_unit
    </select>

    <!--
        æ¸…ç†ä¸‰ä¸ªçŠ¶æ€éƒ½ä¸º0çš„ä¸ŠæŠ¥å•ä½è®°å½•
    -->
    <select id="selectAllZeroStatusUnits" resultType="com.military.asset.entity.ReportUnit">
        SELECT * FROM report_unit
        WHERE source_table_software_asset = 0
        AND source_table_cyber_asset = 0
        AND source_table_data_content_asset = 0
    </select>
    <select id="selectProvinceByReportUnit" resultType="java.lang.String">
        SELECT province
        FROM report_unit
        WHERE report_unit = #{reportUnit}
            LIMIT 1
    </select>

    <select id="selectReportUnitsByProvince" resultType="java.lang.String">
        SELECT report_unit
        FROM report_unit
        WHERE province = #{province}
    </select>

    <!-- ðŸ†• æ–°å¢žï¼šæ ¹æ®ä¸ŠæŠ¥å•ä½åç§°åˆ—è¡¨æ‰¹é‡æŸ¥è¯¢ -->
    <select id="selectByReportUnitNames" resultType="com.military.asset.entity.ReportUnit">
        SELECT
        id,
        report_unit as reportUnit,
        province,
        source_table_cyber_asset as sourceTableCyberAsset,
        source_table_data_content_asset as sourceTableDataContentAsset,
        source_table_software_asset as sourceTableSoftwareAsset
        FROM report_unit
        WHERE report_unit IN
        <foreach collection="unitNames" item="unitName" open="(" separator="," close=")">
            #{unitName}
        </foreach>
        ORDER BY report_unit
    </select>

</mapper>